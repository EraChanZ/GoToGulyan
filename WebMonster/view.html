<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=f3d5a323-5c86-469e-b606-7e3cf11b5ee3&lang=ru_RU" type="text/javascript">
    </script>
    <script type="text/javascript">

        // Функция ymaps.ready() будет вызвана, когда
        // загрузятся все компоненты API, а также когда будет готово DOM-дерево.
        ymaps.ready(init);
        function init(){

            var myMap = new ymaps.Map("map", {
                // Координаты центра карты.
                // Порядок по умолчанию: «широта, долгота».
                // Чтобы не определять координаты центра карты вручную,
                // воспользуйтесь инструментом Определение координат.
                center: [55.76, 37.64],
                // Уровень масштабирования. Допустимые значения:
                // от 0 (весь мир) до 19.
                zoom: 7
            });

            {{if .Authorized}}
                {{if (ne .Cur_user.Lat .Cur_user.Long) }}
                var plc = new ymaps.Placemark([{{.Cur_user.Lat}}, {{.Cur_user.Long}}], {

                },
                {iconImageHref: "{{.Cur_user.Avatar}}",
                    iconLayout: 'default#image',
                    iconImageSize: [34, 42],
                    // Смещение левого верхнего угла иконки относительно
                    // её "ножки" (точки привязки).
                    iconImageOffset: [-5, -38]
                })
                window.prevlandmark = plc
                myMap.geoObjects.add(plc)
                {{end}}

                {{range .Cur_user.AllOtherUsers}}
                    var plc = new ymaps.Placemark([{{.Lat}}, {{.Long}}], {},
                    {iconImageHref: "{{.Avatar}}",
                        iconLayout: 'default#image',
                        iconImageSize: [34, 42],
                        // Смещение левого верхнего угла иконки относительно
                        // её "ножки" (точки привязки).
                        iconImageOffset: [-5, -38]
                    })
                    plc.events.add("click", function (e) {
                        document.getElementById("main_menu").hidden = true
                        document.getElementById("user_page").hidden = false
                        document.getElementById("user_avatar").src = {{.Avatar}}
                        document.getElementById("user_fullname").innerHTML = "{{.Full_name}}"
                        document.getElementById("user_username").innerHTML = "Telegram: @{{.Tg_username}}"
                        openNav()
                    })
                    myMap.geoObjects.add(plc)
                {{end}}

            {{end}}

            myMap.events.add('click', function (e) {
                if (window.choosingloc) {
                    var coords = e.get('coords');
                    var myPlacemarkWithContent = new ymaps.Placemark(coords, {

                        },
                        {iconImageHref: "{{.Cur_user.Avatar}}",
                            iconLayout: 'default#image',
                            iconImageSize: [34, 42],
                            // Смещение левого верхнего угла иконки относительно
                            // её "ножки" (точки привязки).
                            iconImageOffset: [-5, -38]
                        } )

                    if (window.prevlandmark) {
                        myMap.geoObjects.remove(window.prevlandmark)
                    }
                    myMap.geoObjects.add(myPlacemarkWithContent)
                    window.prevlandmark = myPlacemarkWithContent
                }

            });
        }

        function openNav() {
            document.getElementById("openbtn").hidden = true;
            document.getElementById("mySidenav").style.width = "450px";

        }

        function random_sdvig(start_x, start_y, radius) {
            r_angle = Math.random() * 2 * Math.PI
            sdvig_pnt_x = start_x + Math.random() * radius * Math.cos(r_angle)
            sdvig_pnt_y = Math.tan(r_angle) * sdvig_pnt_x + start_y - Math.tan(r_angle) * start_x
            return [sdvig_pnt_x, sdvig_pnt_y]
        }

        function setuploc() {
            if (window.choosingloc) {
                window.choosingloc = false
                document.getElementById("setuploc").innerHTML = "Засетапить точку проживания"
                document.getElementById("Note").innerHTML = ""
                if (window.prevlandmark) {
                    console.log(window.prevlandmark.geometry._coordinates)
                    const XHR = new XMLHttpRequest();
                    console.log("before", window.prevlandmark.geometry._coordinates)
                    drunkcoords = random_sdvig(window.prevlandmark.geometry._coordinates[0], window.prevlandmark.geometry._coordinates[1], 0.01)
                    urlEncodedDataPairs = ["lat="+drunkcoords[0], "long="+drunkcoords[1]]
                    console.log(urlEncodedDataPairs)
                    urlEncodedData = urlEncodedDataPairs.join( '&' ).replace( /%20/g, '+' );
                    /*
                    XHR.addEventListener( 'load', function(event) {
                        alert( 'Yeah! Data sent and response loaded.' );
                    } );

                    // Define what happens in case of error
                    XHR.addEventListener( 'error', function(event) {
                        alert( 'Oops! Something went wrong.' );
                    } );*/

                    // Set up our request
                    XHR.open( 'POST', '/setlocation/' );
                    XHR.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );

                    // Finally, send our data.
                    XHR.send( urlEncodedData );
                }

            }
            else{
                window.choosingloc = true
                document.getElementById("Note").innerHTML = "Внимание! Указанные вами координаты будут сдвинуты на случайное расстояние, чтобы вас никто не подкараулил у подъезда."
                document.getElementById("setuploc").innerHTML = "Выбрал"
            }
        }

        /* Set the width of the side navigation to 0 and the left margin of the page content to 0 */
        function closeNav() {
            document.getElementById("openbtn").hidden = false;
            document.getElementById("mySidenav").style.width = "0";
        }

        function backNav(){
            document.getElementById("main_menu").hidden = false
            document.getElementById("user_page").hidden = true
        }
    </script>
    <style>
        .center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .blured {
            width: 100%;
            height: 100%;
            position: absolute;
            background-image: url(https://images.wallpaperscraft.ru/image/zdaniia_arhitektura_steklo_216439_3840x2160.jpg);
            background-size: cover;
            z-index: -1;
            filter: blur: 4px;
        }


    </style>

</head>
    <body>
    <section class="blured is-fullheight" style="filter: blur(4px)"></section>
        <section class="section">
			<div class="container">
				<div class="columns">
					<div class="column">
					</div>
					<div class="column center" style="padding-top: 12%">
						<div class="box has-text-centered" style="max-width: 500px; padding-bottom: 30px">
                            <figure class="image center">
                                <img src="images/logo.png" style="max-width: 380px; padding-bottom: 10%">
                            </figure>
                            <a href="https://t.me/GoToMeets_bot" class="button is-primary is-outlined">
                                <span class="icon">
                                    <i class="fab fa-telegram-plane"></i>
                                </span>
                                <span>@GoToMeets_bot </span>
                            </a>
						</div>
					</div>
					<div class="column">
					</div>
				</div>
			</div>
		</section>

	</body>
</html>